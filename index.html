<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>部門共用行事曆</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tailwind Configuration for Dark Mode & Custom Colors -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>

  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Flatpickr CDN (僅供日期使用) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css" id="flatpickr-dark-theme" disabled>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Custom Styles -->
  <style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
    .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
    .dark .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #475569; }
    
    .backdrop-blur-sm { backdrop-filter: blur(2px); }
  </style>
</head>
<body class="bg-white dark:bg-[#09090b] text-slate-900 dark:text-slate-100 font-sans transition-colors duration-200 min-h-screen pb-20">

  <!-- Header -->
  <header class="border-b border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-[#09090b]/90 backdrop-blur-md px-4 md:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-20">
    <div class="flex items-center gap-3">
      <div class="p-1.5 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-md shadow-sm">
        <i data-lucide="calendar" class="w-5 h-5"></i>
      </div>
      <div>
        <h1 class="text-base font-bold tracking-tight leading-tight">部門共用行事曆</h1>
        <div class="flex items-center gap-2 text-[11px] text-slate-500 dark:text-slate-400 mt-0.5">
          <span>部門:</span>
          <span id="display-department" class="font-bold text-blue-600 dark:text-blue-400 uppercase px-1.5 py-0.5 bg-blue-50 dark:bg-blue-900/20 rounded"></span>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
      <form id="dept-form" class="flex flex-1 md:flex-none">
        <div class="relative flex items-center w-full md:w-40">
          <i data-lucide="building" class="absolute left-2.5 w-3.5 h-3.5 text-slate-400"></i>
          <input type="text" id="dept-input" placeholder="切換部門代號" class="w-full pl-8 pr-3 py-1.5 text-sm font-medium border border-slate-200 dark:border-slate-800 rounded-l-md bg-transparent focus:outline-none focus:ring-1 focus:ring-slate-400 dark:focus:ring-slate-600 uppercase">
        </div>
        <button type="submit" class="px-3 py-1.5 text-sm font-semibold border border-l-0 border-slate-200 dark:border-slate-800 rounded-r-md bg-slate-50 hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 transition-colors">切換</button>
      </form>
      
      <button onclick="openModal('category-modal')" class="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm" title="管理分類">
        <i data-lucide="settings" class="w-4 h-4"></i>
      </button>
      <button onclick="toggleDarkMode()" class="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm" title="深淺色切換">
        <i id="theme-icon" data-lucide="moon" class="w-4 h-4"></i>
      </button>
    </div>
  </header>

  <!-- Main Workspace -->
  <main class="max-w-[1600px] mx-auto p-4 md:p-6">
    
    <!-- Controls -->
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
      <div class="flex items-center gap-4">
        <div class="relative">
          <button onclick="toggleDatePicker()" class="flex items-center gap-1.5 text-2xl font-black tracking-tight hover:opacity-70 transition-opacity">
            <span id="current-month-year">2026 年 1 月</span>
            <i data-lucide="chevron-down" class="w-6 h-6 text-slate-400"></i>
          </button>
          
          <div id="date-picker-dropdown" class="hidden absolute top-full mt-2 left-0 bg-white dark:bg-[#111113] border border-slate-200 dark:border-slate-800 shadow-xl rounded-lg p-3 z-40 flex gap-2">
            <select id="year-select" onchange="changeYearMonth()" class="p-2 text-sm font-medium border border-slate-200 dark:border-slate-700 rounded bg-transparent outline-none cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"></select>
            <select id="month-select" onchange="changeYearMonth()" class="p-2 text-sm font-medium border border-slate-200 dark:border-slate-700 rounded bg-transparent outline-none cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"></select>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <div class="relative flex items-center shadow-sm rounded-md">
          <i data-lucide="search" class="absolute left-2.5 w-3.5 h-3.5 text-slate-400"></i>
          <input type="text" id="search-input" placeholder="搜尋人員或標題..." class="pl-8 pr-3 py-1.5 text-xs font-medium border border-slate-200 dark:border-slate-800 rounded-md bg-transparent focus:outline-none focus:ring-1 focus:ring-slate-400 w-36 sm:w-48 transition-colors">
        </div>
        
        <select id="filter-category" class="py-1.5 px-2 text-xs font-medium border border-slate-200 dark:border-slate-800 rounded-md bg-transparent focus:outline-none focus:ring-1 focus:ring-slate-400 cursor-pointer transition-colors shadow-sm">
          <option value="all">所有分類</option>
        </select>

        <button onclick="exportToCSV()" class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium border border-slate-200 dark:border-slate-800 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm">
          <i data-lucide="download" class="w-3.5 h-3.5 text-slate-500"></i> <span class="hidden sm:inline">匯出報表</span>
        </button>

        <div class="h-6 w-px bg-slate-200 dark:bg-slate-800 mx-1"></div>

        <button onclick="goToToday()" class="px-3 py-1.5 text-xs font-bold border border-slate-200 dark:border-slate-800 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm">今天</button>
        <div class="flex items-center rounded-md border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
          <button onclick="prevMonth()" class="p-1.5 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-r border-slate-200 dark:border-slate-800">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <button onclick="nextMonth()" class="p-1.5 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Calendar Grid -->
    <div class="border-t border-l border-slate-200 dark:border-slate-800 bg-white dark:bg-[#09090b] rounded-bl-lg rounded-br-lg shadow-sm">
      <div class="grid grid-cols-7 border-b border-slate-200 dark:border-slate-800 bg-slate-50/90 dark:bg-slate-900/90 backdrop-blur-sm sticky top-[60px] z-10">
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-red-500/80 dark:text-red-400/80">週日</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-slate-500">週一</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-slate-500">週二</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-slate-500">週三</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-slate-500">週四</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-slate-500">週五</div>
        <div class="py-2.5 text-center text-xs font-bold border-r border-slate-200 dark:border-slate-800 tracking-widest text-red-500/80 dark:text-red-400/80">週六</div>
      </div>
      <div id="calendar-grid" class="grid grid-cols-7 auto-rows-fr"></div>
    </div>
  </main>

  <div id="toast-container" class="fixed bottom-6 right-6 z-[70] flex flex-col gap-3 pointer-events-none"></div>

  <div class="fixed bottom-4 right-5 z-[40] pointer-events-none bg-white/80 dark:bg-[#0a0a0b]/80 backdrop-blur-md px-3.5 py-1.5 rounded-full shadow-sm border border-slate-200/80 dark:border-slate-800">
    <p class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 tracking-widest uppercase">
      Crafted by <span class="font-black text-slate-900 dark:text-white">勝全</span> ✕ AI
    </p>
  </div>

  <!-- --- Modals --- -->
  
  <!-- Add/Edit Event Modal -->
  <div id="event-modal" class="fixed inset-0 bg-slate-900/20 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-200">
    <div class="modal-content bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden scale-95 transition-transform duration-200">
      <div class="px-5 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/60 bg-slate-50/50 dark:bg-slate-900/50">
        <h3 id="event-modal-title" class="text-base font-bold flex items-center gap-2 text-slate-800 dark:text-white">
          <i data-lucide="plus" class="w-4 h-4 text-blue-500"></i> 新增事項
        </h3>
        <button onclick="closeModal('event-modal')" class="text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 p-1.5 rounded-md transition-colors">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      
      <form id="event-form" class="p-5 space-y-4">
        <input type="hidden" id="form-id">
        
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-end">
          <div class="flex-1 w-full">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">開始日期</label>
            <input required type="text" id="form-start-date" class="w-full px-3 py-2 font-medium bg-white dark:bg-[#09090b] border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer" placeholder="選擇日期">
          </div>
          <div class="flex-1 w-full">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">結束日期</label>
            <input required type="text" id="form-end-date" class="w-full px-3 py-2 font-medium bg-white dark:bg-[#09090b] border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer" placeholder="選擇日期">
          </div>
          <div class="flex items-center gap-2 pb-2.5 cursor-pointer group shrink-0" onclick="toggleAllDay()">
            <div id="allday-toggle-bg" class="w-9 h-5 rounded-full transition-colors relative bg-blue-600 dark:bg-blue-500">
              <div id="allday-toggle-knob" class="absolute top-[2px] left-[2px] bg-white w-4 h-4 rounded-full transition-transform translate-x-4 shadow-sm"></div>
            </div>
            <span id="allday-text" class="text-sm font-bold text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">全天</span>
            <input type="hidden" id="form-is-allday" value="true">
          </div>
        </div>

        <div id="time-inputs" class="hidden flex gap-4 items-center p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-100 dark:border-slate-800">
          <div class="flex-1">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">開始時間</label>
            <input type="text" id="form-start-time" readonly onclick="openCustomTimePicker('form-start-time')" class="w-full px-3 py-1.5 font-bold text-blue-600 dark:text-blue-400 bg-white dark:bg-[#09090b] border border-slate-200 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer text-center shadow-sm" placeholder="選擇時間" value="09:00">
          </div>
          <span class="text-slate-400 mt-5"><i data-lucide="arrow-right" class="w-4 h-4"></i></span>
          <div class="flex-1">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">結束時間</label>
            <input type="text" id="form-end-time" readonly onclick="openCustomTimePicker('form-end-time')" class="w-full px-3 py-1.5 font-bold text-blue-600 dark:text-blue-400 bg-white dark:bg-[#09090b] border border-slate-200 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer text-center shadow-sm" placeholder="選擇時間" value="17:00">
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">負責人姓名 <span class="text-red-500">*</span></label>
            <input required type="text" id="form-name" class="w-full px-3 py-2 font-medium bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="例如: 王大明">
          </div>
          <div class="flex-1">
            <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">分類標籤 <span class="text-red-500">*</span></label>
            <select required id="form-category" class="w-full px-3 py-2 font-medium bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer">
            </select>
          </div>
        </div>

        <div>
          <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider flex items-center justify-between">
            <span>事項標題</span>
            <span class="text-slate-400 font-normal tracking-normal normal-case">(未填將預設為標籤名)</span>
          </label>
          <input type="text" id="form-title" class="w-full px-3 py-2 font-medium bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="例如: 例行維護作業">
        </div>

        <div>
          <label class="block text-[11px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider flex items-center justify-between">
            <span>詳細說明</span>
            <span class="text-slate-400 font-normal tracking-normal normal-case">(選填，支援貼上網址)</span>
          </label>
          <textarea rows="3" id="form-desc" class="w-full px-3 py-2 bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none custom-scrollbar" placeholder="輸入備註細節或貼上會議連結..."></textarea>
        </div>

        <div class="pt-3 flex justify-end gap-2 border-t border-slate-100 dark:border-slate-800 mt-2">
          <button type="button" onclick="closeModal('event-modal')" class="px-5 py-2 mt-2 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">取消</button>
          <button type="submit" id="form-submit-btn" class="px-6 py-2 mt-2 text-sm font-bold bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200 rounded-lg transition-colors shadow-md">建立事項</button>
        </div>
      </form>
    </div>
  </div>

  <div id="time-picker-modal" class="fixed inset-0 bg-slate-900/30 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none transition-opacity duration-200">
    <div class="modal-content bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-2xl w-full max-w-xs shadow-2xl overflow-hidden scale-95 transition-transform duration-200">
      <div class="px-5 py-3.5 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/60 bg-slate-50/50 dark:bg-slate-900/50">
        <h3 class="text-base font-bold flex items-center gap-2 text-slate-800 dark:text-white">
          <i data-lucide="clock" class="w-4 h-4 text-blue-500"></i> <span id="time-picker-title">選擇時間</span>
        </h3>
        <button onclick="closeModal('time-picker-modal')" class="text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 p-1 rounded-md transition-colors">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      
      <div class="p-5">
        <div class="mb-4">
          <div class="text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest flex items-center gap-1.5"><i data-lucide="sun" class="w-3.5 h-3.5"></i> 上午 (AM)</div>
          <div class="grid grid-cols-5 gap-1.5">
            <button type="button" onclick="selectTimePickerHour(8)" class="tp-hr tp-hr-8 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">08</button>
            <button type="button" onclick="selectTimePickerHour(9)" class="tp-hr tp-hr-9 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">09</button>
            <button type="button" onclick="selectTimePickerHour(10)" class="tp-hr tp-hr-10 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">10</button>
            <button type="button" onclick="selectTimePickerHour(11)" class="tp-hr tp-hr-11 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">11</button>
            <button type="button" onclick="selectTimePickerHour(12)" class="tp-hr tp-hr-12 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">12</button>
          </div>
        </div>

        <div class="mb-5">
          <div class="text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest flex items-center justify-between">
            <span class="flex items-center gap-1.5"><i data-lucide="sunset" class="w-3.5 h-3.5"></i> 下午 (PM)</span>
            <span class="text-[9px] bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-slate-500">選 1 即 13:00</span>
          </div>
          <div class="grid grid-cols-5 gap-1.5">
            <button type="button" onclick="selectTimePickerHour(13)" class="tp-hr tp-hr-13 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">1</button>
            <button type="button" onclick="selectTimePickerHour(14)" class="tp-hr tp-hr-14 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">2</button>
            <button type="button" onclick="selectTimePickerHour(15)" class="tp-hr tp-hr-15 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">3</button>
            <button type="button" onclick="selectTimePickerHour(16)" class="tp-hr tp-hr-16 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">4</button>
            <button type="button" onclick="selectTimePickerHour(17)" class="tp-hr tp-hr-17 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">5</button>
          </div>
        </div>

        <div class="mb-5 pt-4 border-t border-slate-100 dark:border-slate-800/60">
          <div class="text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest flex items-center gap-1.5"><i data-lucide="timer" class="w-3.5 h-3.5"></i> 分鐘</div>
          <div class="grid grid-cols-4 gap-2">
            <button type="button" onclick="selectTimePickerMin(0)" class="tp-min tp-min-0 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">00</button>
            <button type="button" onclick="selectTimePickerMin(15)" class="tp-min tp-min-15 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">15</button>
            <button type="button" onclick="selectTimePickerMin(30)" class="tp-min tp-min-30 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">30</button>
            <button type="button" onclick="selectTimePickerMin(45)" class="tp-min tp-min-45 py-2 rounded-lg font-bold text-sm bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all">45</button>
          </div>
        </div>
        
        <div class="pt-3 flex justify-between items-center">
          <div class="text-3xl font-black text-blue-600 dark:text-blue-400 tracking-wider font-mono" id="time-picker-display">09:00</div>
          <button type="button" onclick="closeModal('time-picker-modal')" class="px-6 py-2.5 text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors shadow-md">確認輸入</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-modal" class="fixed inset-0 bg-slate-900/20 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-200">
    <div class="modal-content bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden scale-95 transition-transform duration-200">
      <div class="px-6 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/60 bg-slate-50/50 dark:bg-slate-900/50">
        <div id="view-badge" class="px-2.5 py-1 rounded-[4px] text-[10px] font-bold tracking-widest uppercase">未分類</div>
        <div class="flex gap-1.5">
          <button onclick="startEditMode()" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-800 rounded-md transition-colors" title="編輯此紀錄"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
          <button onclick="closeModal('view-modal')" class="p-1.5 text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
      </div>
      
      <div class="p-6">
        <h3 id="view-title" class="text-xl font-bold mb-5 leading-tight break-words text-slate-900 dark:text-white">標題</h3>
        
        <div class="space-y-3 mb-6 bg-slate-50 dark:bg-slate-900/40 p-4 rounded-xl border border-slate-100 dark:border-slate-800/50">
          <div class="flex items-start gap-3 text-sm text-slate-600 dark:text-slate-300">
            <i data-lucide="calendar" class="w-4 h-4 text-slate-400 min-w-[16px] mt-0.5"></i>
            <div>
              <div id="view-date" class="font-semibold text-slate-800 dark:text-slate-200">YYYY/MM/DD</div>
              <div id="view-time-container" class="hidden mt-0.5">
                <span id="view-time" class="font-medium text-slate-500">09:00 - 17:00</span>
              </div>
            </div>
          </div>
          <div class="h-px w-full bg-slate-200/60 dark:bg-slate-700/50"></div>
          <div class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300">
            <i data-lucide="user" class="w-4 h-4 text-slate-400 min-w-[16px]"></i>
            <span id="view-name" class="font-bold text-slate-800 dark:text-slate-200">姓名</span>
            <span id="view-type" class="text-[10px] px-2 py-0.5 bg-slate-200/50 dark:bg-slate-800 rounded font-bold tracking-wider text-slate-500 ml-auto">全天</span>
          </div>
        </div>

        <div id="view-desc-container" class="hidden">
          <h4 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">詳細說明</h4>
          <div id="view-desc" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed"></div>
        </div>
      </div>

      <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900/50 flex justify-end border-t border-slate-100 dark:border-slate-800 mt-2">
        <button onclick="deleteSelectedEvent()" class="flex items-center gap-1.5 px-4 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg text-xs font-bold transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4"></i> 刪除紀錄
        </button>
      </div>
    </div>
  </div>

  <div id="category-modal" class="fixed inset-0 bg-slate-900/20 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-200">
    <div class="modal-content bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh] scale-95 transition-transform duration-200">
      <div class="px-5 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/60 bg-slate-50/50 dark:bg-slate-900/50">
        <h3 class="text-base font-bold flex items-center gap-2 text-slate-800 dark:text-white">
          <i data-lucide="settings" class="w-4 h-4 text-slate-500"></i> 標籤管理
        </h3>
        <button onclick="closeModal('category-modal')" class="text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 p-1.5 rounded-md transition-colors">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      
      <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
        <form id="cat-form" class="bg-slate-50 dark:bg-slate-900/40 p-5 rounded-xl border border-slate-200 dark:border-slate-800 mb-8">
          <h4 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-1.5"><i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> 新增分類</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-[11px] font-bold text-slate-500 mb-1">標籤名稱</label>
              <input required type="text" id="new-cat-name" placeholder="例如: 外部會議" class="w-full px-3 py-2 bg-white dark:bg-[#09090b] border border-slate-300 dark:border-slate-700 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500/50">
            </div>
            
            <div>
              <label class="block text-[11px] font-bold text-slate-500 mb-1.5">選擇代表色</label>
              <input type="hidden" id="new-cat-theme" value="blue">
              <div id="theme-selector" class="grid grid-cols-3 gap-2">
              </div>
            </div>
            
            <button type="submit" class="w-full py-2 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-lg text-sm font-bold transition-colors shadow-sm mt-2">建立標籤</button>
          </div>
        </form>

        <h4 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-3 pl-1 flex items-center gap-1.5"><i data-lucide="tag" class="w-3.5 h-3.5"></i> 現有分類</h4>
        <div id="category-list" class="space-y-2.5">
        </div>
      </div>
    </div>
  </div>


  <!-- --- Firebase & Application Logic --- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAXnSDK_kY4Aa8XvL0M_Md9kA4Wdow_Uvs",
      authDomain: "daily-23c82.firebaseapp.com",
      projectId: "daily-23c82",
      storageBucket: "daily-23c82.firebasestorage.app",
      messagingSenderId: "574719251457",
      appId: "1:574719251457:web:30aadb364406783b175c00"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const globalAppId = 'daily-23c82-app';

    const THEME_COLORS = {
      blue: { id: 'blue', label: '藍色', allDay: 'bg-blue-500 text-white border border-blue-600', timeEvent: 'bg-blue-50 dark:bg-blue-500/10 border-l-[3px] border-blue-500 text-blue-700 dark:text-blue-300' },
      green: { id: 'green', label: '綠色', allDay: 'bg-green-500 text-white border border-green-600', timeEvent: 'bg-green-50 dark:bg-green-500/10 border-l-[3px] border-green-500 text-green-700 dark:text-green-300' },
      red: { id: 'red', label: '紅色', allDay: 'bg-red-500 text-white border border-red-600', timeEvent: 'bg-red-50 dark:bg-red-500/10 border-l-[3px] border-red-500 text-red-700 dark:text-red-300' },
      yellow: { id: 'yellow', label: '黃色', allDay: 'bg-yellow-500 text-white border border-yellow-600', timeEvent: 'bg-amber-50 dark:bg-yellow-500/10 border-l-[3px] border-yellow-500 text-amber-700 dark:text-yellow-300' },
      purple: { id: 'purple', label: '紫色', allDay: 'bg-purple-500 text-white border border-purple-600', timeEvent: 'bg-purple-50 dark:bg-purple-500/10 border-l-[3px] border-purple-500 text-purple-700 dark:text-purple-300' },
      gray: { id: 'gray', label: '灰色', allDay: 'bg-slate-600 text-white border border-slate-700', timeEvent: 'bg-slate-100 dark:bg-slate-800 border-l-[3px] border-slate-500 text-slate-700 dark:text-slate-300' }
    };

    window.state = {
      isDark: false,
      user: null,
      department: localStorage.getItem('calendar_saved_dept') || 'public',
      currentDate: new Date(),
      todayStr: '',
      events: [],
      categories: [],
      holidays: {},
      selectedEvent: null,
      searchQuery: '',
      filterCategory: 'all',
      unsubEvents: null,
      unsubCats: null
    };

    const formatToYYYYMMDD = (date) => {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}${mm}${dd}`;
    };
    
    window.state.todayStr = formatToYYYYMMDD(new Date());

    const parseYYYYMMDD_to_Dash = (ds) => {
      if (!ds) return '';
      return `${ds.substring(0,4)}-${ds.substring(4,6)}-${ds.substring(6,8)}`;
    };

    const escapeHTML = (str) => {
      return (str||'').replace(/[&<>'"]/g, tag => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
      }[tag]));
    };

    const linkify = (text) => {
      const safeText = escapeHTML(text);
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return safeText.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-500 dark:text-blue-400 hover:underline underline-offset-2 break-all">$1</a>');
    };

    const getCategoryTheme = (categoryId) => {
      const cat = window.state.categories.find(c => c.id === categoryId);
      if (!cat) return THEME_COLORS.gray;
      if (cat.themeId && THEME_COLORS[cat.themeId]) return THEME_COLORS[cat.themeId];
      return THEME_COLORS.gray;
    };

    window.showToast = (message, type = 'success') => {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColor = type === 'success' ? 'bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900' : 'bg-red-600 text-white';
      const iconName = type === 'success' ? 'check-circle-2' : 'alert-circle';
      
      toast.className = `flex items-center gap-2.5 px-4 py-3 rounded-lg shadow-xl font-bold text-sm transform translate-y-8 opacity-0 transition-all duration-300 ease-out pointer-events-auto ${bgColor}`;
      toast.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i> <span>${message}</span>`;
      
      container.appendChild(toast);
      lucide.createIcons();
      
      requestAnimationFrame(() => {
        toast.classList.remove('translate-y-8', 'opacity-0');
      });
      
      setTimeout(() => {
        toast.classList.add('translate-y-4', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    window.openModal = (id) => {
      const modal = document.getElementById(id);
      const content = modal.querySelector('.modal-content');
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.classList.add('opacity-100');
      content.classList.remove('scale-95');
      content.classList.add('scale-100');
      if (id === 'category-modal') renderCategoryThemeSelector();
      lucide.createIcons();
    };

    window.closeModal = (id) => {
      const modal = document.getElementById(id);
      const content = modal.querySelector('.modal-content');
      modal.classList.remove('opacity-100');
      modal.classList.add('opacity-0', 'pointer-events-none');
      content.classList.remove('scale-100');
      content.classList.add('scale-95');
    };

    window.toggleDarkMode = () => {
      window.state.isDark = !window.state.isDark;
      document.documentElement.classList.toggle('dark', window.state.isDark);
      const icon = document.getElementById('theme-icon');
      icon.setAttribute('data-lucide', window.state.isDark ? 'sun' : 'moon');
      
      const flatpickrTheme = document.getElementById('flatpickr-dark-theme');
      if (window.state.isDark) {
          flatpickrTheme.removeAttribute('disabled');
      } else {
          flatpickrTheme.setAttribute('disabled', 'true');
      }

      lucide.createIcons();
    };

    window.toggleDatePicker = () => {
      const dp = document.getElementById('date-picker-dropdown');
      dp.classList.toggle('hidden');
    };

    document.addEventListener('mousedown', (e) => {
      const btn = document.querySelector('[onclick="toggleDatePicker()"]');
      const dropdown = document.getElementById('date-picker-dropdown');
      if (btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    window.currentTimeTarget = null;
    
    window.openCustomTimePicker = (inputId) => {
      window.currentTimeTarget = inputId;
      const title = inputId === 'form-start-time' ? '選擇開始時間' : '選擇結束時間';
      document.getElementById('time-picker-title').textContent = title;
      
      const currentVal = document.getElementById(inputId).value || '09:00';
      const [h, m] = currentVal.split(':').map(Number);
      
      updateTimePickerUI(h, m);
      openModal('time-picker-modal');
    };

    window.selectTimePickerHour = (h) => {
      const currentVal = document.getElementById(window.currentTimeTarget).value || '09:00';
      const [_, m] = currentVal.split(':').map(Number);
      const newTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      document.getElementById(window.currentTimeTarget).value = newTime;
      updateTimePickerUI(h, m);
    };

    window.selectTimePickerMin = (m) => {
      const currentVal = document.getElementById(window.currentTimeTarget).value || '09:00';
      const [h, _] = currentVal.split(':').map(Number);
      const newTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      document.getElementById(window.currentTimeTarget).value = newTime;
      updateTimePickerUI(h, m);
    };

    const updateTimePickerUI = (h, m) => {
      document.getElementById('time-picker-display').textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      
      document.querySelectorAll('.tp-hr, .tp-min').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-600', 'shadow-md');
        btn.classList.add('bg-slate-50', 'dark:bg-slate-800/50', 'text-slate-700', 'dark:text-slate-300');
      });
      
      const hrBtn = document.querySelector(`.tp-hr-${h}`);
      const minBtn = document.querySelector(`.tp-min-${m}`);
      
      if(hrBtn) {
        hrBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-600', 'shadow-md');
        hrBtn.classList.remove('bg-slate-50', 'dark:bg-slate-800/50', 'text-slate-700', 'dark:text-slate-300');
      }
      if(minBtn) {
        minBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-600', 'shadow-md');
        minBtn.classList.remove('bg-slate-50', 'dark:bg-slate-800/50', 'text-slate-700', 'dark:text-slate-300');
      }
    };

    window.prevMonth = () => {
      window.state.currentDate = new Date(window.state.currentDate.getFullYear(), window.state.currentDate.getMonth() - 1, 1);
      renderCalendar();
    };
    window.nextMonth = () => {
      window.state.currentDate = new Date(window.state.currentDate.getFullYear(), window.state.currentDate.getMonth() + 1, 1);
      renderCalendar();
    };
    window.goToToday = () => {
      window.state.currentDate = new Date();
      renderCalendar();
    };
    window.changeYearMonth = () => {
      const y = document.getElementById('year-select').value;
      const m = document.getElementById('month-select').value;
      window.state.currentDate = new Date(y, m, 1);
      document.getElementById('date-picker-dropdown').classList.add('hidden');
      renderCalendar();
    };

    window.exportToCSV = () => {
      const currentY = window.state.currentDate.getFullYear();
      const currentM = window.state.currentDate.getMonth() + 1;
      const prefix = `${currentY}${String(currentM).padStart(2, '0')}`;
      
      const monthEvents = window.state.events.filter(e => {
        const start = e.dateString;
        const end = e.endDateString || e.dateString;
        return (start.startsWith(prefix) || (end >= prefix+'01' && start <= prefix+'31'));
      });

      if (monthEvents.length === 0) return showToast('本月份沒有資料可以匯出', 'error');

      let csvContent = "\uFEFF"; 
      csvContent += "開始日期,結束日期,事項模式,開始時間,結束時間,分類,負責人,標題,詳細說明\n";
      
      monthEvents.forEach(e => {
        const cat = window.state.categories.find(c => c.id === e.categoryId);
        const catName = cat ? cat.name : '未分類';
        const mode = e.isAllDay ? '全天' : '指定時間';
        const stTime = e.isAllDay ? '' : e.startTime;
        const enTime = e.isAllDay ? '' : e.endTime;
        const endDStr = e.endDateString || e.dateString;
        
        const row = [
          parseYYYYMMDD_to_Dash(e.dateString),
          parseYYYYMMDD_to_Dash(endDStr),
          mode, stTime, enTime, catName, e.name, e.title,
          (e.description || '').replace(/\n/g, ' ') 
        ].map(v => `"${(v||'').replace(/"/g, '""')}"`).join(",");
        csvContent += row + "\n";
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `TeamSync_${window.state.department}_${currentY}年${currentM}月.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`已下載 ${monthEvents.length} 筆紀錄報表`);
    };

    document.getElementById('search-input').addEventListener('input', (e) => {
      window.state.searchQuery = e.target.value.toLowerCase();
      renderCalendar();
    });
    
    document.getElementById('filter-category').addEventListener('change', (e) => {
      window.state.filterCategory = e.target.value;
      renderCalendar();
    });

    const fetchHolidays = async () => {
      const year = window.state.currentDate.getFullYear();
      try {
        const response = await fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${year}.json`);
        if (response.ok) {
          const data = await response.json();
          data.forEach(day => { if (day.isHoliday) window.state.holidays[day.date] = day.description || '休假日'; });
          renderCalendar();
        }
      } catch (error) { console.error(error); }
    };

    const setupFirebaseListeners = () => {
      if (!window.state.user) return;
      if (window.state.unsubEvents) window.state.unsubEvents();
      if (window.state.unsubCats) window.state.unsubCats();

      const deptKey = window.state.department.toLowerCase();
      const eventsRef = collection(db, 'artifacts', globalAppId, 'public', 'data', `events_${deptKey}`);
      const categoriesRef = collection(db, 'artifacts', globalAppId, 'public', 'data', `categories_${deptKey}`);

      window.state.unsubEvents = onSnapshot(eventsRef, (snapshot) => {
        window.state.events = [];
        snapshot.forEach(doc => window.state.events.push({ id: doc.id, ...doc.data() }));
        renderCalendar();
      });

      window.state.unsubCats = onSnapshot(categoriesRef, (snapshot) => {
        window.state.categories = [];
        snapshot.forEach(doc => window.state.categories.push({ id: doc.id, ...doc.data() }));
        if (window.state.categories.length === 0) {
          addDoc(categoriesRef, { name: '請假', themeId: 'blue' });
          addDoc(categoriesRef, { name: '交辦事項', themeId: 'green' });
        }
        updateCategoryOptions();
        renderCategoryList();
        renderCalendar();
      });
    };

    document.getElementById('dept-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const val = document.getElementById('dept-input').value.trim();
      if (val && val !== window.state.department) {
        window.state.department = val;
        localStorage.setItem('calendar_saved_dept', val);
        document.getElementById('display-department').textContent = val;
        setupFirebaseListeners();
        showToast(`已切換至 [ ${val.toUpperCase()} ] 空間`);
        document.getElementById('dept-input').value = '';
      }
    });

    const renderCalendar = () => {
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      
      const year = window.state.currentDate.getFullYear();
      const month = window.state.currentDate.getMonth();
      document.getElementById('current-month-year').textContent = `${year} 年 ${month + 1} 月`;
      
      const currentYearStr = year.toString();
      if (!document.querySelector(`#year-select option[value="${currentYearStr}"]`)) {
          document.getElementById('year-select').innerHTML += `<option value="${year}">${year} 年</option>`;
      }
      document.getElementById('year-select').value = year;
      document.getElementById('month-select').value = month;

      if (!window.state.holidays[`${year}0101`]) fetchHolidays();

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay();
      
      const days = [];
      for (let i = 0; i < firstDay; i++) days.push({ date: new Date(year, month, -firstDay + i + 1), isCurrent: false });
      for (let i = 1; i <= daysInMonth; i++) days.push({ date: new Date(year, month, i), isCurrent: true });
      const remainingDays = 42 - days.length; 
      for (let i = 1; i <= remainingDays; i++) days.push({ date: new Date(year, month + 1, i), isCurrent: false });

      const q = window.state.searchQuery;
      const f = window.state.filterCategory;
      const filteredEvents = window.state.events.filter(e => {
         if (f !== 'all' && e.categoryId !== f) return false;
         if (q) {
            const matchName = e.name && e.name.toLowerCase().includes(q);
            const matchTitle = e.title && e.title.toLowerCase().includes(q);
            if (!matchName && !matchTitle) return false;
         }
         return true;
      });

      days.forEach(dayObj => {
        const dateStr = formatToYYYYMMDD(dayObj.date);
        const isWeekend = dayObj.date.getDay() === 0 || dayObj.date.getDay() === 6;
        const holidayName = window.state.holidays[dateStr];
        const isRedDay = isWeekend || holidayName;
        const isToday = dateStr === window.state.todayStr;

        // ★★★ 核心改動區域：跨日排程的狀態拆分邏輯 ★★★
        const dayEvents = filteredEvents.filter(e => {
          const startStr = e.dateString;
          const endStr = e.endDateString || e.dateString;
          return dateStr >= startStr && dateStr <= endStr;
        }).map(e => {
          const endStr = e.endDateString || e.dateString;
          const isMultiDay = e.dateString !== endStr;
          
          let displayIsAllDay = e.isAllDay;
          let displayTimeStr = '';

          // 判斷跨日事件在當天的呈現方式
          if (!e.isAllDay) {
              if (isMultiDay) {
                  if (dateStr === e.dateString) {
                      // 第一天：如果從上班時間(08:00或09:00)開始，視覺上填滿整天
                      if (e.startTime === '08:00' || e.startTime === '09:00') {
                          displayIsAllDay = true;
                      } else {
                          displayTimeStr = `${e.startTime}起`;
                      }
                  } else if (dateStr === endStr) {
                      // 最後一天：如果到下班時間(17:00)結束，視覺上填滿整天
                      if (e.endTime === '17:00') {
                          displayIsAllDay = true;
                      } else {
                          displayTimeStr = `至${e.endTime}`;
                      }
                  } else {
                      displayIsAllDay = true;             // 中間日轉為全天顯示
                  }
              } else {
                  displayTimeStr = e.startTime;           // 單日事件
              }
          }
          return { original: e, displayIsAllDay, displayTimeStr };
        }).sort((a, b) => {
          if (a.displayIsAllDay !== b.displayIsAllDay) return a.displayIsAllDay ? -1 : 1;
          return (a.original.startTime || '').localeCompare(b.original.startTime || '');
        });

        let bgClass = 'bg-transparent';
        let textClass = 'text-slate-900 dark:text-slate-100';
        if (!dayObj.isCurrent) {
          bgClass = 'bg-slate-50/50 dark:bg-[#111113]';
          textClass = 'text-slate-400 dark:text-slate-600';
        } else if (isRedDay) {
          bgClass = 'bg-red-50/40 dark:bg-red-950/20';
          textClass = 'text-red-600 dark:text-red-400';
        }

        const cell = document.createElement('div');
        cell.className = `min-h-[140px] border-r border-b border-slate-200 dark:border-slate-800 p-1.5 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors flex flex-col ${bgClass}`;
        cell.onclick = () => openAddModal(dayObj.date);

        let eventsHtml = dayEvents.map(item => {
          const evt = item.original;
          const theme = getCategoryTheme(evt.categoryId);
          const evtJson = escapeHTML(JSON.stringify(evt));
          
          const safeDesc = escapeHTML(evt.description || '');
          const tooltip = `${evt.name}: ${evt.title}${safeDesc ? ' \n' + safeDesc : ''}`;
          
          const endDStr = evt.endDateString || evt.dateString;
          const isPast = evt.isAllDay ? endDStr < window.state.todayStr : (endDStr === window.state.todayStr ? false : endDStr < window.state.todayStr);
          const visualOpacity = isPast ? 'opacity-40 hover:opacity-80 grayscale-[30%]' : '';

          // 依照新的判定結果 (displayIsAllDay) 來決定套用哪種樣式
          if (item.displayIsAllDay) {
            return `<div title="${tooltip}" onclick="openViewModal(event, '${evtJson}')" class="px-1.5 py-[3px] rounded-[4px] text-[11px] font-bold truncate hover:brightness-95 transition-all cursor-pointer shadow-sm ${theme.allDay} ${visualOpacity}">${evt.name}: ${evt.title}</div>`;
          }
          return `<div title="${tooltip}" onclick="openViewModal(event, '${evtJson}')" class="px-1.5 py-[3px] rounded-[4px] text-[11px] font-bold truncate hover:brightness-95 transition-all cursor-pointer shadow-sm ${theme.timeEvent} ${visualOpacity}"><span class="font-black mr-1 opacity-80">${item.displayTimeStr}</span>${evt.name}: ${evt.title}</div>`;
        }).join('');

        cell.innerHTML = `
          <div class="flex flex-col items-center mb-1.5">
            <div class="w-7 h-7 flex items-center justify-center rounded-full text-[13px] font-bold ${isToday ? 'bg-blue-600 text-white shadow-md' : textClass}">${dayObj.date.getDate()}</div>
            ${holidayName && dayObj.isCurrent ? `<span class="text-[10px] font-bold text-red-500 dark:text-red-400 truncate max-w-full px-1 mt-0.5">${holidayName}</span>` : ''}
          </div>
          <div class="flex-1 overflow-y-auto space-y-[4px] mt-0.5 pr-0.5 custom-scrollbar">${eventsHtml}</div>
        `;
        grid.appendChild(cell);
      });
      lucide.createIcons();
    };

    window.openAddModal = (dateObj) => {
      const yyyy_mm_dd = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
      
      document.getElementById('form-id').value = '';
      
      document.getElementById('form-start-date')._flatpickr.setDate(yyyy_mm_dd);
      document.getElementById('form-end-date')._flatpickr.setDate(yyyy_mm_dd);
      document.getElementById('form-end-date')._flatpickr.set('minDate', yyyy_mm_dd); 
      
      document.getElementById('form-title').value = '';
      if(!document.getElementById('form-name').value) document.getElementById('form-name').value = '';
      document.getElementById('form-desc').value = '';
      
      document.getElementById('form-start-time').value = '09:00';
      document.getElementById('form-end-time').value = '17:00';
      
      document.getElementById('form-is-allday').value = 'true';
      
      updateAllDayUI(true);
      document.getElementById('event-modal-title').innerHTML = '<i data-lucide="plus" class="w-4 h-4 text-blue-500"></i> 新增事項';
      document.getElementById('form-submit-btn').textContent = '建立事項';

      if(window.state.categories.length > 0 && !document.getElementById('form-id').value) {
          document.getElementById('form-category').value = window.state.categories[0].id;
      }

      openModal('event-modal');
    };

    window.openViewModal = (e, eventJsonStr) => {
      e.stopPropagation();
      const parser = new DOMParser();
      const decodedJson = parser.parseFromString(eventJsonStr, "text/html").documentElement.textContent;
      const evt = JSON.parse(decodedJson);
      window.state.selectedEvent = evt;
      
      const theme = getCategoryTheme(evt.categoryId);
      const cat = window.state.categories.find(c => c.id === evt.categoryId);
      
      document.getElementById('view-badge').className = `px-2.5 py-1 rounded-[4px] text-[10px] font-bold tracking-widest uppercase shadow-sm ${theme.allDay}`;
      document.getElementById('view-badge').textContent = cat ? cat.name : '未分類';
      
      document.getElementById('view-title').textContent = evt.title;
      
      const sDate = parseYYYYMMDD_to_Dash(evt.dateString).replace(/-/g, '/');
      const eDate = parseYYYYMMDD_to_Dash(evt.endDateString || evt.dateString).replace(/-/g, '/');
      document.getElementById('view-date').textContent = sDate === eDate ? sDate : `${sDate} - ${eDate}`;
      
      document.getElementById('view-name').textContent = evt.name;
      
      if (evt.isAllDay) {
        document.getElementById('view-time-container').classList.add('hidden');
        document.getElementById('view-type').textContent = '全天';
      } else {
        document.getElementById('view-time-container').classList.remove('hidden');
        document.getElementById('view-time').textContent = `${evt.startTime} - ${evt.endTime}`;
        document.getElementById('view-type').textContent = '特定時間';
      }

      if (evt.description) {
        document.getElementById('view-desc-container').classList.remove('hidden');
        document.getElementById('view-desc').innerHTML = linkify(evt.description);
      } else {
        document.getElementById('view-desc-container').classList.add('hidden');
      }

      openModal('view-modal');
    };

    window.startEditMode = () => {
      const evt = window.state.selectedEvent;
      
      document.getElementById('form-id').value = evt.id;
      
      const startD = parseYYYYMMDD_to_Dash(evt.dateString);
      const endD = parseYYYYMMDD_to_Dash(evt.endDateString || evt.dateString);
      
      document.getElementById('form-start-date')._flatpickr.setDate(startD);
      document.getElementById('form-end-date')._flatpickr.setDate(endD);
      document.getElementById('form-end-date')._flatpickr.set('minDate', startD);
      
      document.getElementById('form-title').value = evt.title;
      document.getElementById('form-name').value = evt.name;
      document.getElementById('form-category').value = evt.categoryId;
      document.getElementById('form-desc').value = evt.description || '';
      
      document.getElementById('form-is-allday').value = evt.isAllDay ? 'true' : 'false';
      updateAllDayUI(evt.isAllDay);
      if(!evt.isAllDay) {
        document.getElementById('form-start-time').value = evt.startTime;
        document.getElementById('form-end-time').value = evt.endTime;
      }

      document.getElementById('event-modal-title').innerHTML = '<i data-lucide="edit-2" class="w-4 h-4 text-blue-500"></i> 編輯事項';
      document.getElementById('form-submit-btn').textContent = '儲存變更';

      closeModal('view-modal');
      setTimeout(() => openModal('event-modal'), 200); 
    };

    window.toggleAllDay = () => {
      const input = document.getElementById('form-is-allday');
      const isAllDay = input.value === 'true';
      input.value = (!isAllDay).toString();
      updateAllDayUI(!isAllDay);
    };

    const updateAllDayUI = (isAllDay) => {
      const bg = document.getElementById('allday-toggle-bg');
      const knob = document.getElementById('allday-toggle-knob');
      const times = document.getElementById('time-inputs');

      if (isAllDay) {
        bg.className = 'w-9 h-5 rounded-full transition-colors relative bg-blue-600 dark:bg-blue-500';
        knob.className = 'absolute top-[2px] left-[2px] bg-white w-4 h-4 rounded-full transition-transform translate-x-4 shadow-sm';
        times.classList.add('hidden');
      } else {
        bg.className = 'w-9 h-5 rounded-full transition-colors relative bg-slate-300 dark:bg-slate-700';
        knob.className = 'absolute top-[2px] left-[2px] bg-white dark:bg-slate-300 w-4 h-4 rounded-full transition-transform translate-x-0 shadow-sm';
        times.classList.remove('hidden');
      }
    };

    document.getElementById('event-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!window.state.user) return;

      const id = document.getElementById('form-id').value;
      const isAllDay = document.getElementById('form-is-allday').value === 'true';
      
      const sDateStr = document.getElementById('form-start-date').value.replace(/-/g, '');
      const eDateStr = document.getElementById('form-end-date').value.replace(/-/g, '');
      const finalEndDate = eDateStr < sDateStr ? sDateStr : eDateStr;

      const catSelect = document.getElementById('form-category');
      let finalTitle = document.getElementById('form-title').value.trim();
      if (!finalTitle) {
        finalTitle = catSelect.options[catSelect.selectedIndex]?.text || '未命名事項';
      }
      
      const payload = {
        dateString: sDateStr,
        endDateString: finalEndDate,
        title: finalTitle,
        name: document.getElementById('form-name').value.trim(),
        categoryId: document.getElementById('form-category').value,
        description: document.getElementById('form-desc').value.trim(),
        isAllDay: isAllDay,
        startTime: isAllDay ? null : document.getElementById('form-start-time').value,
        endTime: isAllDay ? null : document.getElementById('form-end-time').value,
        updatedAt: new Date().toISOString()
      };

      const deptKey = window.state.department.toLowerCase();
      
      if (id) {
        await updateDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', `events_${deptKey}`, id), payload);
        showToast('已儲存變更');
      } else {
        payload.createdAt = new Date().toISOString();
        await addDoc(collection(db, 'artifacts', globalAppId, 'public', 'data', `events_${deptKey}`), payload);
        showToast('已建立新事項');
      }
      closeModal('event-modal');
    });

    window.deleteSelectedEvent = async () => {
      if (!window.state.user || !window.state.selectedEvent) return;
      const deptKey = window.state.department.toLowerCase();
      await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', `events_${deptKey}`, window.state.selectedEvent.id));
      closeModal('view-modal');
      showToast('紀錄已永久刪除');
    };

    const updateCategoryOptions = () => {
      const select = document.getElementById('form-category');
      const filterSelect = document.getElementById('filter-category');
      const curFilter = filterSelect.value;
      
      const opts = window.state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      select.innerHTML = opts;
      filterSelect.innerHTML = `<option value="all">所有分類</option>` + opts;
      filterSelect.value = curFilter || 'all';
    };

    window.selectNewCatTheme = (themeId) => {
      document.getElementById('new-cat-theme').value = themeId;
      renderCategoryThemeSelector();
    };

    const renderCategoryThemeSelector = () => {
      const container = document.getElementById('theme-selector');
      const activeId = document.getElementById('new-cat-theme').value;
      
      container.innerHTML = Object.values(THEME_COLORS).map(theme => {
        const isActive = activeId === theme.id;
        const ringClass = isActive ? 'ring-2 ring-offset-1 ring-slate-900 dark:ring-slate-100 ring-offset-slate-50 dark:ring-offset-slate-900 shadow-md' : 'opacity-50 hover:opacity-100';
        return `<div onclick="selectNewCatTheme('${theme.id}')" class="cursor-pointer px-2 py-2 rounded-lg text-[11px] font-bold text-center transition-all ${theme.allDay} ${ringClass}">${theme.label.split(' ')[0]}</div>`;
      }).join('');
    };

    const renderCategoryList = () => {
      const container = document.getElementById('category-list');
      container.innerHTML = window.state.categories.map(cat => {
        const theme = getCategoryTheme(cat.id);
        return `
          <div class="flex justify-between items-center p-3 border border-slate-200 dark:border-slate-700/50 rounded-lg bg-white dark:bg-[#111113] shadow-sm">
            <span class="px-2.5 py-1 rounded-[4px] text-[10px] font-bold uppercase tracking-widest ${theme.allDay}">${cat.name}</span>
            <button onclick="deleteCategory('${cat.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
          </div>
        `;
      }).join('');
      lucide.createIcons();
    };

    document.getElementById('cat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!window.state.user) return;
      
      const name = document.getElementById('new-cat-name').value.trim();
      const themeId = document.getElementById('new-cat-theme').value;
      
      const deptKey = window.state.department.toLowerCase();
      await addDoc(collection(db, 'artifacts', globalAppId, 'public', 'data', `categories_${deptKey}`), { name, themeId });
      
      document.getElementById('new-cat-name').value = '';
      selectNewCatTheme('blue');
      showToast(`已新增標籤: ${name}`);
    });

    window.deleteCategory = async (id) => {
      if (!window.state.user) return;
      const deptKey = window.state.department.toLowerCase();
      await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', `categories_${deptKey}`, id));
      showToast('標籤已刪除');
    };

    const initApp = async () => {
      document.getElementById('display-department').textContent = window.state.department;
      
      const endDatePicker = flatpickr("#form-end-date", {
          dateFormat: "Y-m-d",
          disableMobile: "true"
      });

      flatpickr("#form-start-date", {
          dateFormat: "Y-m-d",
          disableMobile: "true",
          onChange: function(selectedDates, dateStr, instance) {
              endDatePicker.set('minDate', dateStr);
              if (document.getElementById('form-end-date').value && document.getElementById('form-end-date').value < dateStr) {
                  endDatePicker.setDate(dateStr);
              }
          }
      });
      
      const yearSelect = document.getElementById('year-select');
      const monthSelect = document.getElementById('month-select');
      const baseYear = new Date().getFullYear();
      for(let i=0; i<10; i++) yearSelect.innerHTML += `<option value="${baseYear - 5 + i}">${baseYear - 5 + i} 年</option>`;
      for(let i=0; i<12; i++) monthSelect.innerHTML += `<option value="${i}">${i + 1} 月</option>`;

      lucide.createIcons();
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.state.user = user;
          setupFirebaseListeners();
        }
      });
      try { await signInAnonymously(auth); } catch (e) { console.error(e); }
    };

    window.addEventListener('DOMContentLoaded', initApp);

  </script>
</body>
</html>
