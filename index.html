import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  ChevronLeft, ChevronRight, Calendar as CalendarIcon, 
  Plus, User, AlignLeft, Settings, X, Trash2, Building, 
  Sun, Moon, Edit2, ChevronDown
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, collection, onSnapshot, doc, deleteDoc, addDoc, updateDoc 
} from 'firebase/firestore';

// --- Firebase Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyAXnSDK_kY4Aa8XvL0M_Md9kA4Wdow_Uvs",
  authDomain: "daily-23c82.firebaseapp.com",
  projectId: "daily-23c82",
  storageBucket: "daily-23c82.firebasestorage.app",
  messagingSenderId: "574719251457",
  appId: "1:574719251457:web:30aadb364406783b175c00",
  measurementId: "G-6JN0N6BJHH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'daily-23c82-app';

// --- Professional Theme Palette ---
// 針對「全天(色塊)」與「特定時間(左邊框)」做獨立的高辨識度設計
const THEME_COLORS = {
  blue: { id: 'blue', label: '藍色 (休假/個人)', allDay: 'bg-blue-500 text-white', timeEvent: 'bg-blue-50 dark:bg-blue-500/10 border-l-[3px] border-blue-500 text-blue-700 dark:text-blue-300' },
  green: { id: 'green', label: '綠色 (交辦事項)', allDay: 'bg-green-500 text-white', timeEvent: 'bg-green-50 dark:bg-green-500/10 border-l-[3px] border-green-500 text-green-700 dark:text-green-300' },
  red: { id: 'red', label: '紅色 (緊急/重要)', allDay: 'bg-red-500 text-white', timeEvent: 'bg-red-50 dark:bg-red-500/10 border-l-[3px] border-red-500 text-red-700 dark:text-red-300' },
  yellow: { id: 'yellow', label: '黃色 (會議/討論)', allDay: 'bg-yellow-500 text-white', timeEvent: 'bg-amber-50 dark:bg-yellow-500/10 border-l-[3px] border-yellow-500 text-amber-700 dark:text-yellow-300' },
  purple: { id: 'purple', label: '紫色 (專案/活動)', allDay: 'bg-purple-500 text-white', timeEvent: 'bg-purple-50 dark:bg-purple-500/10 border-l-[3px] border-purple-500 text-purple-700 dark:text-purple-300' },
  gray: { id: 'gray', label: '灰色 (其他/備忘)', allDay: 'bg-gray-500 text-white', timeEvent: 'bg-gray-100 dark:bg-gray-800 border-l-[3px] border-gray-500 text-gray-700 dark:text-gray-300' }
};

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [user, setUser] = useState(null);
  const [departmentInput, setDepartmentInput] = useState('mis');
  const [activeDepartment, setActiveDepartment] = useState('mis');
  
  const [events, setEvents] = useState([]);
  const [categories, setCategories] = useState([]);
  const [holidays, setHolidays] = useState({});
  
  const [currentDate, setCurrentDate] = useState(new Date());
  const [showEventModal, setShowEventModal] = useState(false);
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [showDatePicker, setShowDatePicker] = useState(false);
  
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [selectedEvent, setSelectedEvent] = useState(null);
  
  const defaultForm = { id: null, title: '', name: '', categoryId: '', description: '', isAllDay: true, startTime: '09:00', endTime: '18:00' };
  const [formData, setFormData] = useState(defaultForm);
  const [newCategoryThemeId, setNewCategoryThemeId] = useState('blue');
  const [newCategoryName, setNewCategoryName] = useState('');

  const datePickerRef = useRef(null);
  useEffect(() => {
    function handleClickOutside(event) {
      if (datePickerRef.current && !datePickerRef.current.contains(event.target)) setShowDatePicker(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    const initAuth = async () => { try { await signInAnonymously(auth); } catch (error) { console.error(error); } };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const fetchHolidays = async () => {
      const year = currentDate.getFullYear();
      try {
        const response = await fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${year}.json`);
        if (response.ok) {
          const data = await response.json();
          const holidayMap = {};
          data.forEach(day => { if (day.isHoliday) holidayMap[day.date] = day.description || '休假日'; });
          setHolidays(prev => ({ ...prev, ...holidayMap }));
        }
      } catch (error) { console.error(error); }
    };
    fetchHolidays();
  }, [currentDate.getFullYear()]);

  useEffect(() => {
    if (!user) return;
    const deptKey = activeDepartment.toLowerCase();
    const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', `events_${deptKey}`);
    const categoriesRef = collection(db, 'artifacts', appId, 'public', 'data', `categories_${deptKey}`);

    const unsubEvents = onSnapshot(eventsRef, (snapshot) => {
      const evts = [];
      snapshot.forEach(doc => evts.push({ id: doc.id, ...doc.data() }));
      setEvents(evts);
    });

    const unsubCats = onSnapshot(categoriesRef, (snapshot) => {
      const cats = [];
      snapshot.forEach(doc => cats.push({ id: doc.id, ...doc.data() }));
      if (cats.length === 0) {
        addDoc(categoriesRef, { name: '請假', themeId: 'blue' });
        addDoc(categoriesRef, { name: '交辦事項', themeId: 'green' });
      } else {
        setCategories(cats);
      }
    });

    return () => { unsubEvents(); unsubCats(); };
  }, [user, activeDepartment]);

  const formatToYYYYMMDD = (date) => {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    return `${yyyy}${mm}${dd}`;
  };

  // 核心修復：強健的顏色解析邏輯 (模糊匹配舊資料)
  const getCategoryTheme = (categoryId) => {
    const cat = categories.find(c => c.id === categoryId);
    if (!cat) return THEME_COLORS.gray;
    
    // 如果已有新版 themeId 直接回傳
    if (cat.themeId && THEME_COLORS[cat.themeId]) return THEME_COLORS[cat.themeId];
    
    // 向後相容：從舊的 colorClass 字串中捕捉關鍵字
    const legacyStr = (cat.colorClass || '').toLowerCase();
    if (legacyStr.includes('blue')) return THEME_COLORS.blue;
    if (legacyStr.includes('green')) return THEME_COLORS.green;
    if (legacyStr.includes('red')) return THEME_COLORS.red;
    if (legacyStr.includes('yellow')) return THEME_COLORS.yellow;
    if (legacyStr.includes('purple')) return THEME_COLORS.purple;
    
    return THEME_COLORS.gray;
  };

  const calendarDays = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    
    const days = [];
    for (let i = 0; i < firstDay; i++) days.push({ date: new Date(year, month, -firstDay + i + 1), isCurrentMonth: false });
    for (let i = 1; i <= daysInMonth; i++) days.push({ date: new Date(year, month, i), isCurrentMonth: true });
    const remainingDays = 42 - days.length; 
    for (let i = 1; i <= remainingDays; i++) days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
    return days;
  }, [currentDate]);

  const handleDepartmentSwitch = (e) => {
    e.preventDefault();
    if (departmentInput.trim()) setActiveDepartment(departmentInput.trim());
  };

  const openAddModal = (date) => {
    setSelectedDate(date);
    setFormData({ ...defaultForm, categoryId: categories[0]?.id || '' });
    setShowEventModal(true);
  };

  const openViewModal = (e, event) => {
    e.stopPropagation();
    setSelectedEvent(event);
    setShowViewModal(true);
  };

  const startEditMode = () => {
    const y = parseInt(selectedEvent.dateString.substring(0,4));
    const m = parseInt(selectedEvent.dateString.substring(4,6)) - 1;
    const d = parseInt(selectedEvent.dateString.substring(6,8));
    setSelectedDate(new Date(y, m, d));
    
    setFormData({
      id: selectedEvent.id,
      title: selectedEvent.title,
      name: selectedEvent.name,
      categoryId: selectedEvent.categoryId,
      description: selectedEvent.description || '',
      isAllDay: selectedEvent.isAllDay,
      startTime: selectedEvent.startTime || '09:00',
      endTime: selectedEvent.endTime || '18:00'
    });
    setShowViewModal(false);
    setShowEventModal(true);
  };

  const saveEvent = async (e) => {
    e.preventDefault();
    if (!user || !formData.title || !formData.name) return;

    const deptKey = activeDepartment.toLowerCase();
    const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', `events_${deptKey}`);
    
    const eventPayload = {
      dateString: formatToYYYYMMDD(selectedDate),
      title: formData.title,
      name: formData.name,
      categoryId: formData.categoryId,
      description: formData.description,
      isAllDay: formData.isAllDay,
      startTime: formData.isAllDay ? null : formData.startTime,
      endTime: formData.isAllDay ? null : formData.endTime,
      updatedAt: new Date().toISOString()
    };

    if (formData.id) {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `events_${deptKey}`, formData.id), eventPayload);
    } else {
      eventPayload.createdAt = new Date().toISOString();
      await addDoc(eventsRef, eventPayload);
    }
    setShowEventModal(false);
  };

  const deleteEvent = async () => {
    if (!user || !selectedEvent) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `events_${activeDepartment.toLowerCase()}`, selectedEvent.id));
    setShowViewModal(false);
  };

  const saveCategory = async (e) => {
    e.preventDefault();
    if (!user || !newCategoryName) return;
    const categoriesRef = collection(db, 'artifacts', appId, 'public', 'data', `categories_${activeDepartment.toLowerCase()}`);
    
    // 儲存時統一使用乾淨的 themeId
    await addDoc(categoriesRef, {
      name: newCategoryName,
      themeId: newCategoryThemeId
    });
    setNewCategoryName('');
    setNewCategoryThemeId('blue');
  };

  const deleteCategory = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `categories_${activeDepartment.toLowerCase()}`, id));
  };

  const years = Array.from({ length: 10 }, (_, i) => new Date().getFullYear() - 5 + i);
  const months = Array.from({ length: 12 }, (_, i) => i);

  return (
    <div className={`${isDark ? 'dark' : ''}`}>
      <div className="min-h-screen bg-white dark:bg-[#09090b] text-slate-900 dark:text-slate-100 font-sans transition-colors duration-200">
        
        {/* --- Header (Clean SaaS Toolbar) --- */}
        <header className="border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-[#09090b] px-4 md:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-10">
          <div className="flex items-center gap-3">
            <div className="p-1.5 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-md">
              <CalendarIcon size={20} />
            </div>
            <div>
              <h1 className="text-base font-semibold tracking-tight leading-tight">部門共用行事曆</h1>
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>部門空間:</span>
                <span className="font-semibold text-slate-900 dark:text-white uppercase px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded">{activeDepartment}</span>
              </div>
            </div>
          </div>

          <div className="flex items-center gap-2 w-full md:w-auto">
            <form onSubmit={handleDepartmentSwitch} className="flex flex-1 md:flex-none">
              <div className="relative flex items-center w-full md:w-40">
                <Building size={14} className="absolute left-2.5 text-slate-400" />
                <input
                  type="text"
                  value={departmentInput}
                  onChange={(e) => setDepartmentInput(e.target.value)}
                  placeholder="部門代號"
                  className="w-full pl-8 pr-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800 rounded-l-md bg-transparent focus:outline-none focus:ring-1 focus:ring-slate-400 dark:focus:ring-slate-600 uppercase"
                />
              </div>
              <button type="submit" className="px-3 py-1.5 text-sm font-medium border border-l-0 border-slate-200 dark:border-slate-800 rounded-r-md bg-slate-50 hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 transition-colors">
                切換
              </button>
            </form>
            
            <button onClick={() => setShowCategoryModal(true)} className="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="管理分類">
              <Settings size={18} />
            </button>
            <button onClick={() => setIsDark(!isDark)} className="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="深淺色切換">
              {isDark ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>
        </header>

        {/* --- Main Calendar Workspace --- */}
        <main className="max-w-[1600px] mx-auto p-4 md:p-6 pb-20">
          
          {/* Calendar Controls */}
          <div className="flex items-center justify-between mb-4">
            <div className="relative" ref={datePickerRef}>
              <button 
                onClick={() => setShowDatePicker(!showDatePicker)}
                className="flex items-center gap-1.5 text-xl font-bold hover:opacity-70 transition-opacity"
              >
                {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
                <ChevronDown size={20} className="text-slate-400" />
              </button>
              
              {showDatePicker && (
                <div className="absolute top-full mt-1 left-0 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-lg rounded-lg p-2 z-50 flex gap-2">
                  <select 
                    value={currentDate.getFullYear()}
                    onChange={(e) => { setCurrentDate(new Date(Number(e.target.value), currentDate.getMonth(), 1)); setShowDatePicker(false); }}
                    className="p-1.5 text-sm border border-slate-200 dark:border-slate-700 rounded bg-transparent outline-none cursor-pointer"
                  >
                    {years.map(y => <option key={y} value={y}>{y} 年</option>)}
                  </select>
                  <select 
                    value={currentDate.getMonth()}
                    onChange={(e) => { setCurrentDate(new Date(currentDate.getFullYear(), Number(e.target.value), 1)); setShowDatePicker(false); }}
                    className="p-1.5 text-sm border border-slate-200 dark:border-slate-700 rounded bg-transparent outline-none cursor-pointer"
                  >
                    {months.map(m => <option key={m} value={m}>{m + 1} 月</option>)}
                  </select>
                </div>
              )}
            </div>

            <div className="flex items-center gap-1">
              <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1.5 text-sm font-medium border border-slate-200 dark:border-slate-800 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors mr-2">
                今天
              </button>
              <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <ChevronLeft size={18} />
              </button>
              <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1.5 border border-slate-200 dark:border-slate-800 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <ChevronRight size={18} />
              </button>
            </div>
          </div>

          {/* Seamless Grid Design (No gap-px, pure borders) */}
          <div className="border-t border-l border-slate-200 dark:border-slate-800 bg-white dark:bg-[#09090b]">
            
            {/* Days Header */}
            <div className="grid grid-cols-7 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
              {['週日', '週一', '週二', '週三', '週四', '週五', '週六'].map((day, idx) => (
                <div key={day} className={`py-2 text-center text-xs font-semibold border-r border-slate-200 dark:border-slate-800 uppercase tracking-wider ${idx === 0 || idx === 6 ? 'text-red-500/80 dark:text-red-400/80' : 'text-slate-500'}`}>
                  {day}
                </div>
              ))}
            </div>

            {/* Calendar Grid */}
            <div className="grid grid-cols-7 auto-rows-fr">
              {calendarDays.map((dayObj, idx) => {
                const dateStr = formatToYYYYMMDD(dayObj.date);
                const isWeekend = dayObj.date.getDay() === 0 || dayObj.date.getDay() === 6;
                const holidayName = holidays[dateStr];
                const isRedDay = isWeekend || holidayName;
                const isToday = dateStr === formatToYYYYMMDD(new Date());
                
                const dayEvents = events.filter(e => e.dateString === dateStr).sort((a, b) => {
                  if (a.isAllDay !== b.isAllDay) return a.isAllDay ? -1 : 1;
                  return (a.startTime || '').localeCompare(b.startTime || '');
                });

                let bgClass = 'bg-transparent';
                let textClass = 'text-slate-900 dark:text-slate-100';
                
                if (!dayObj.isCurrentMonth) {
                  bgClass = 'bg-slate-50/50 dark:bg-[#111113]';
                  textClass = 'text-slate-400 dark:text-slate-600';
                } else if (isRedDay) {
                  bgClass = 'bg-red-50/40 dark:bg-red-950/20';
                  textClass = 'text-red-600 dark:text-red-400';
                }

                return (
                  <div 
                    key={idx} 
                    onClick={() => openAddModal(dayObj.date)}
                    className={`min-h-[140px] border-r border-b border-slate-200 dark:border-slate-800 p-1.5 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors flex flex-col ${bgClass}`}
                  >
                    <div className="flex flex-col items-center mb-1">
                      <div className={`
                        w-7 h-7 flex items-center justify-center rounded-full text-[13px] font-medium
                        ${isToday ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900' : textClass}
                      `}>
                        {dayObj.date.getDate()}
                      </div>
                      {holidayName && dayObj.isCurrentMonth && (
                        <span className="text-[10px] font-medium text-red-500 dark:text-red-400 truncate max-w-full px-1">
                          {holidayName}
                        </span>
                      )}
                    </div>
                    
                    {/* Absolutely Obvious Event Rendering */}
                    <div className="flex-1 overflow-y-auto space-y-[3px] mt-0.5 pr-0.5 custom-scrollbar">
                      {dayEvents.map(evt => {
                        const theme = getCategoryTheme(evt.categoryId);
                        
                        // All Day: Solid Fill
                        if (evt.isAllDay) {
                          return (
                            <div key={evt.id} onClick={(e) => openViewModal(e, evt)}
                              className={`px-1.5 py-[3px] rounded-sm text-[11px] font-medium truncate hover:brightness-95 transition-all cursor-pointer ${theme.allDay}`}>
                              {evt.name}: {evt.title}
                            </div>
                          );
                        }
                        
                        // Timed Event: Thick Left Border + Light BG
                        return (
                          <div key={evt.id} onClick={(e) => openViewModal(e, evt)}
                            className={`px-1.5 py-[3px] rounded-sm text-[11px] font-medium truncate hover:brightness-95 transition-all cursor-pointer ${theme.timeEvent}`}>
                            <span className="font-bold mr-1 opacity-80">{evt.startTime}</span>
                            {evt.name}: {evt.title}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </main>

        <div className="fixed bottom-3 right-4 pointer-events-none">
          <p className="text-[10px] font-medium text-slate-400 dark:text-slate-600 tracking-widest uppercase">
            Crafted by <span className="font-bold">勝全</span> ✕ AI
          </p>
        </div>

        {/* --- Modals (Shadcn-like Minimalist Style) --- */}
        {showEventModal && (
          <div className="fixed inset-0 bg-black/40 dark:bg-black/60 backdrop-blur-[2px] flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-xl w-full max-w-md shadow-xl overflow-hidden animate-in zoom-in-95 duration-200">
              <div className="px-5 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/50">
                <h3 className="text-base font-semibold flex items-center gap-2">
                  {formData.id ? <Edit2 size={16} className="text-slate-400" /> : <Plus size={16} className="text-slate-400" />}
                  {formData.id ? '編輯事項' : '新增事項'}
                </h3>
                <button onClick={() => setShowEventModal(false)} className="text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
                  <X size={18} />
                </button>
              </div>
              
              <form onSubmit={saveEvent} className="p-5 space-y-4">
                <div className="flex gap-3">
                  <div className="flex-1 bg-slate-50 dark:bg-slate-900 px-3 py-2 rounded-md border border-slate-200 dark:border-slate-800">
                    <p className="text-[10px] text-slate-500 uppercase tracking-wide font-semibold mb-0.5">日期</p>
                    <p className="text-sm font-medium">
                      {selectedDate.getFullYear()}/{selectedDate.getMonth() + 1}/{selectedDate.getDate()}
                    </p>
                  </div>
                  <div className="flex-1 bg-slate-50 dark:bg-slate-900 px-3 py-2 rounded-md border border-slate-200 dark:border-slate-800 flex flex-col justify-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                       onClick={() => setFormData({...formData, isAllDay: !formData.isAllDay})}>
                    <p className="text-[10px] text-slate-500 uppercase tracking-wide font-semibold mb-0.5">模式</p>
                    <div className="flex items-center gap-2">
                      <div className={`w-7 h-4 rounded-full transition-colors relative ${formData.isAllDay ? 'bg-slate-900 dark:bg-slate-100' : 'bg-slate-300 dark:bg-slate-700'}`}>
                        <div className={`absolute top-[2px] left-[2px] bg-white dark:bg-slate-900 w-3 h-3 rounded-full transition-transform ${formData.isAllDay ? 'translate-x-3' : ''}`}></div>
                      </div>
                      <span className="text-sm font-medium">{formData.isAllDay ? '全天' : '指定時間'}</span>
                    </div>
                  </div>
                </div>

                {!formData.isAllDay && (
                  <div className="flex gap-3 items-center">
                    <div className="flex-1">
                      <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">開始時間</label>
                      <input type="time" required={!formData.isAllDay} className="w-full px-3 py-1.5 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" value={formData.startTime} onChange={e => setFormData({...formData, startTime: e.target.value})} />
                    </div>
                    <span className="text-slate-400 mt-5">-</span>
                    <div className="flex-1">
                      <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">結束時間</label>
                      <input type="time" required={!formData.isAllDay} className="w-full px-3 py-1.5 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" value={formData.endTime} onChange={e => setFormData({...formData, endTime: e.target.value})} />
                    </div>
                  </div>
                )}

                <div>
                  <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">事項標題 <span className="text-red-500">*</span></label>
                  <input required type="text" className="w-full px-3 py-2 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" placeholder="例如：伺服器維護" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                </div>

                <div className="flex gap-3">
                  <div className="flex-1">
                    <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">負責人姓名 <span className="text-red-500">*</span></label>
                    <input required type="text" className="w-full px-3 py-2 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" placeholder="姓名" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                  </div>
                  <div className="flex-1">
                    <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">分類標籤 <span className="text-red-500">*</span></label>
                    <select required className="w-full px-3 py-2 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" value={formData.categoryId} onChange={e => setFormData({...formData, categoryId: e.target.value})}>
                      {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-[11px] font-semibold text-slate-600 dark:text-slate-400 mb-1">詳細說明 (選填)</label>
                  <textarea rows="2" className="w-full px-3 py-2 bg-transparent border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400 resize-none" placeholder="輸入備註細節..." value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}></textarea>
                </div>

                <div className="pt-3 flex justify-end gap-2">
                  <button type="button" onClick={() => setShowEventModal(false)} className="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors">取消</button>
                  <button type="submit" className="px-4 py-2 text-sm bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200 rounded-md font-medium transition-colors shadow-sm">
                    {formData.id ? '儲存變更' : '建立事項'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* --- Modal: View Event --- */}
        {showViewModal && selectedEvent && (
          <div className="fixed inset-0 bg-black/40 dark:bg-black/60 backdrop-blur-[2px] flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-xl w-full max-w-sm shadow-xl overflow-hidden animate-in zoom-in-95 duration-200">
              <div className="px-5 py-3 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/50">
                <div className={`px-2 py-0.5 rounded text-[10px] font-bold tracking-wide ${getCategoryTheme(selectedEvent.categoryId).allDay}`}>
                  {categories.find(c => c.id === selectedEvent.categoryId)?.name || '未分類'}
                </div>
                <div className="flex gap-1">
                  <button onClick={startEditMode} className="p-1 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors" title="編輯此紀錄"><Edit2 size={16} /></button>
                  <button onClick={() => setShowViewModal(false)} className="p-1 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"><X size={16} /></button>
                </div>
              </div>
              
              <div className="p-5">
                <h3 className="text-lg font-semibold mb-4 leading-tight">{selectedEvent.title}</h3>
                
                <div className="space-y-2 mb-6">
                  <div className="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400">
                    <CalendarIcon size={16} className="text-slate-400" /> 
                    <span>{selectedEvent.dateString.substring(0,4)}/{selectedEvent.dateString.substring(4,6)}/{selectedEvent.dateString.substring(6,8)}</span>
                    {!selectedEvent.isAllDay && (
                       <div className="flex items-center gap-1.5 pl-3 border-l border-slate-300 dark:border-slate-700 ml-1">
                         <span className="font-medium text-slate-900 dark:text-slate-200">{selectedEvent.startTime} - {selectedEvent.endTime}</span>
                       </div>
                    )}
                  </div>
                  <div className="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400">
                    <User size={16} className="text-slate-400" /> 
                    <span className="font-medium text-slate-900 dark:text-white">{selectedEvent.name}</span>
                    <span className="text-[10px] px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded text-slate-500">
                      {selectedEvent.isAllDay ? '全天' : '特定時間'}
                    </span>
                  </div>
                </div>

                {selectedEvent.description && (
                  <div className="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed bg-slate-50 dark:bg-slate-900 p-3 rounded-md border border-slate-100 dark:border-slate-800">
                    {selectedEvent.description}
                  </div>
                )}
              </div>

              <div className="px-5 py-3 bg-slate-50 dark:bg-slate-900/50 flex justify-end border-t border-slate-100 dark:border-slate-800">
                <button onClick={deleteEvent} className="flex items-center gap-1.5 px-3 py-1.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-md text-xs font-semibold transition-colors">
                  <Trash2 size={14} /> 刪除紀錄
                </button>
              </div>
            </div>
          </div>
        )}

        {/* --- Modal: Manage Categories --- */}
        {showCategoryModal && (
          <div className="fixed inset-0 bg-black/40 dark:bg-black/60 backdrop-blur-[2px] flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-[#0f0f11] border border-slate-200 dark:border-slate-800 rounded-xl w-full max-w-md shadow-xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-200">
              <div className="px-5 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800/50">
                <h3 className="text-base font-semibold flex items-center gap-2">
                  <Settings size={16} className="text-slate-400" /> 標籤管理
                </h3>
                <button onClick={() => setShowCategoryModal(false)} className="text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
                  <X size={18} />
                </button>
              </div>
              
              <div className="p-5 overflow-y-auto flex-1">
                <form onSubmit={saveCategory} className="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-800 mb-6">
                  <h4 className="font-semibold text-xs text-slate-500 uppercase tracking-wide mb-3">新增分類</h4>
                  <div className="space-y-3">
                    <input required type="text" placeholder="輸入分類名稱" className="w-full px-3 py-2 bg-white dark:bg-[#0f0f11] border border-slate-300 dark:border-slate-700 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-slate-900 dark:focus:ring-slate-400" value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} />
                    
                    <div className="grid grid-cols-3 gap-2">
                      {Object.values(THEME_COLORS).map((theme) => (
                        <div key={theme.id} onClick={() => setNewCategoryThemeId(theme.id)}
                          className={`cursor-pointer px-2 py-1.5 rounded text-[11px] font-medium text-center transition-all ${theme.allDay} ${newCategoryThemeId === theme.id ? 'ring-2 ring-offset-1 ring-slate-900 dark:ring-slate-100 ring-offset-slate-50 dark:ring-offset-slate-900' : 'opacity-60 hover:opacity-100'}`}>
                          {theme.label.split(' ')[0]}
                        </div>
                      ))}
                    </div>
                    
                    <button type="submit" className="w-full py-2 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-md text-sm font-medium transition-colors mt-2">
                      建立標籤
                    </button>
                  </div>
                </form>

                <h4 className="font-semibold text-xs text-slate-500 uppercase tracking-wide mb-3">現有分類</h4>
                <div className="space-y-2">
                  {categories.map(cat => {
                    const theme = getCategoryTheme(cat.id);
                    return (
                      <div key={cat.id} className="flex justify-between items-center p-2.5 border border-slate-200 dark:border-slate-800 rounded-md bg-white dark:bg-transparent">
                        <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${theme.allDay}`}>
                          {cat.name}
                        </span>
                        <button onClick={() => deleteCategory(cat.id)} className="p-1.5 text-slate-400 hover:text-red-600 rounded-md transition-colors">
                          <Trash2 size={16} />
                        </button>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        )}
        
        <style dangerouslySetInnerHTML={{__html: `
          .custom-scrollbar::-webkit-scrollbar { width: 4px; }
          .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
          .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
          .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
          .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
          .dark .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #475569; }
        `}} />
      </div>
    </div>
  );
}
